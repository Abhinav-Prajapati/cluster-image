<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Clustering with DBSCAN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="range"] {
            width: 200px;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .clusters-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .cluster {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .cluster-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .cluster-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .cluster-count {
            color: #666;
            font-size: 14px;
        }
        
        .noise-cluster .cluster-header {
            border-bottom-color: #ff6b6b;
        }
        
        .noise-cluster .cluster-title {
            color: #ff6b6b;
        }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .image-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .image-container {
            width: 150px;
            height: 150px;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .image-name {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
            word-break: break-all;
            max-width: 150px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .stats-row {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Image Clustering with DBSCAN</h1>
            <div class="controls">
                <div class="control-group">
                    <button id="loadData">Load Images from data.js</button>
                </div>
            </div>
            
            <div class="controls" style="margin-top: 15px;">
                <div class="slider-container">
                    <label for="epsilon">Epsilon (Sensitivity):</label>
                    <input type="range" id="epsilon" min="0.1" max="2.0" step="0.1" value="0.5">
                    <span id="epsilonValue">0.5</span>
                </div>
                <div class="control-group">
                    <label for="minSamples">Min Samples:</label>
                    <input type="number" id="minSamples" min="1" max="20" value="3" style="width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="control-group">
                    <button id="clusterBtn" disabled>Cluster Images</button>
                </div>
            </div>
            
            <div id="status" class="status"></div>
        </div>
        
        <div id="stats" class="stats" style="display: none;">
            <div class="stats-row">
                <div class="stat-item">
                    <div id="totalImages" class="stat-value">0</div>
                    <div class="stat-label">Total Images</div>
                </div>
                <div class="stat-item">
                    <div id="totalClusters" class="stat-value">0</div>
                    <div class="stat-label">Clusters</div>
                </div>
                <div class="stat-item">
                    <div id="noiseImages" class="stat-value">0</div>
                    <div class="stat-label">Noise Images</div>
                </div>
            </div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <div>Processing images...</div>
        </div>
        
        <div id="clustersContainer" class="clusters-container"></div>
    </div>

    <!-- Load the data from data.js file -->
    <script src="data.js"></script>
    
    <script>
        let currentClusters = [];
        
        // Update epsilon value display
        document.getElementById('epsilon').addEventListener('input', (e) => {
            document.getElementById('epsilonValue').textContent = e.target.value;
        });
        
        // Load data from data.js file
        document.getElementById('loadData').addEventListener('click', () => {
            showStatus('Loading images from data.js file...', 'info');
            document.getElementById('loadData').disabled = true;
            
            try {
                // Check if imageData is loaded from data.js
                if (typeof imageData === 'undefined') {
                    throw new Error('data.js file not found or not loaded. Please run extract_data.py first to generate data.js');
                }
                
                if (!imageData || imageData.length === 0) {
                    throw new Error('No images found in data.js. Please check your database has data.');
                }
                
                document.getElementById('clusterBtn').disabled = false;
                showStatus(`Successfully loaded ${imageData.length} images from data.js file.`, 'info');
                
            } catch (error) {
                showStatus(`Error loading data: ${error.message}`, 'error');
            } finally {
                document.getElementById('loadData').disabled = false;
            }
        });
        
        // DBSCAN clustering implementation
        function dbscan(points, epsilon, minSamples) {
            const clusters = [];
            const visited = new Set();
            const noise = new Set();
            
            function euclideanDistance(a, b) {
                let sum = 0;
                for (let i = 0; i < a.length; i++) {
                    sum += Math.pow(a[i] - b[i], 2);
                }
                return Math.sqrt(sum);
            }
            
            function getNeighbors(pointIndex) {
                const neighbors = [];
                for (let i = 0; i < points.length; i++) {
                    if (i !== pointIndex && euclideanDistance(points[pointIndex].embedding, points[i].embedding) <= epsilon) {
                        neighbors.push(i);
                    }
                }
                return neighbors;
            }
            
            for (let i = 0; i < points.length; i++) {
                if (visited.has(i)) continue;
                
                visited.add(i);
                const neighbors = getNeighbors(i);
                
                if (neighbors.length < minSamples) {
                    noise.add(i);
                } else {
                    const cluster = [i];
                    
                    for (let j = 0; j < neighbors.length; j++) {
                        const neighbor = neighbors[j];
                        
                        if (!visited.has(neighbor)) {
                            visited.add(neighbor);
                            const neighborNeighbors = getNeighbors(neighbor);
                            
                            if (neighborNeighbors.length >= minSamples) {
                                neighbors.push(...neighborNeighbors);
                            }
                        }
                        
                        if (!clusters.some(c => c.includes(neighbor)) && !noise.has(neighbor)) {
                            cluster.push(neighbor);
                        }
                    }
                    
                    clusters.push(cluster);
                }
            }
            
            return { clusters, noise: Array.from(noise) };
        }
        
        // Cluster button click handler
        document.getElementById('clusterBtn').addEventListener('click', () => {
            if (typeof imageData === 'undefined' || imageData.length === 0) {
                showStatus('Please load images first.', 'error');
                return;
            }
            
            const epsilon = parseFloat(document.getElementById('epsilon').value);
            const minSamples = parseInt(document.getElementById('minSamples').value);
            
            showLoading(true);
            showStatus('Clustering images...', 'info');
            
            try {
                // Run clustering in a setTimeout to allow UI to update
                setTimeout(() => {
                    const result = dbscan(imageData, epsilon, minSamples);
                    currentClusters = result.clusters;
                    const noiseIndices = result.noise;
                    
                    displayClusters(currentClusters, noiseIndices);
                    updateStats(currentClusters.length, noiseIndices.length);
                    
                    showLoading(false);
                    showStatus(`Clustering complete. Found ${currentClusters.length} clusters and ${noiseIndices.length} noise images.`, 'info');
                }, 100);
                
            } catch (error) {
                showLoading(false);
                showStatus(`Error during clustering: ${error.message}`, 'error');
            }
        });
        
        // Display clusters in the UI
        function displayClusters(clusters, noiseIndices) {
            const container = document.getElementById('clustersContainer');
            container.innerHTML = '';
            
            // Display regular clusters
            clusters.forEach((cluster, index) => {
                const clusterDiv = createClusterDiv(`Cluster ${index + 1}`, cluster, false);
                container.appendChild(clusterDiv);
            });
            
            // Display noise cluster if there are noise points
            if (noiseIndices.length > 0) {
                const noiseDiv = createClusterDiv('Noise (Unclustered)', noiseIndices, true);
                container.appendChild(noiseDiv);
            }
        }
        
        // Create a cluster div element
        function createClusterDiv(title, imageIndices, isNoise) {
            const clusterDiv = document.createElement('div');
            clusterDiv.className = `cluster ${isNoise ? 'noise-cluster' : ''}`;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'cluster-header';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'cluster-title';
            titleDiv.textContent = title;
            
            const countDiv = document.createElement('div');
            countDiv.className = 'cluster-count';
            countDiv.textContent = `${imageIndices.length} images`;
            
            headerDiv.appendChild(titleDiv);
            headerDiv.appendChild(countDiv);
            
            const imagesGrid = document.createElement('div');
            imagesGrid.className = 'images-grid';
            
            imageIndices.forEach(index => {
                const imageItem = createImageItem(imageData[index]);
                imagesGrid.appendChild(imageItem);
            });
            
            clusterDiv.appendChild(headerDiv);
            clusterDiv.appendChild(imagesGrid);
            
            return clusterDiv;
        }
        
        // Create an image item element
        function createImageItem(imageInfo) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'image-item';
            
            const containerDiv = document.createElement('div');
            containerDiv.className = 'image-container';
            
            const img = document.createElement('img');
            // Use the actual image path from database - you'll need to serve these files
            img.src = imageInfo.image_path; // Use actual path from database
            img.alt = imageInfo.filename;
            img.onerror = () => {
                containerDiv.innerHTML = '<div style="color: #999; font-size: 12px;">Image not found<br>' + imageInfo.filename + '</div>';
            };
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'image-name';
            nameDiv.textContent = imageInfo.filename;
            nameDiv.title = imageInfo.image_path;
            
            containerDiv.appendChild(img);
            itemDiv.appendChild(containerDiv);
            itemDiv.appendChild(nameDiv);
            
            return itemDiv;
        }
        
        // Update statistics display
        function updateStats(clusterCount, noiseCount) {
            document.getElementById('totalImages').textContent = imageData.length;
            document.getElementById('totalClusters').textContent = clusterCount;
            document.getElementById('noiseImages').textContent = noiseCount;
            document.getElementById('stats').style.display = 'block';
        }
        
        // Show/hide loading spinner
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // Show status messages
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            // Hide status after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>